!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(i.Wetf=i.Wetf||{})}(this,function(i){"use strict";i.Packer=class{constructor(i={}){if(this._compressor=i.compression??!1,this._stringEncoding=["string","binary"].indexOf(i.encoding?.string?.toLowerCase()??"")+1||1,this._keyEncoding=["atom","binary","string"].indexOf(i.encoding?.key?.toLowerCase()??"")+1||1,this._safeIntEncoding=["bigint","float"].indexOf(i.encoding?.safeInt?.toLowerCase()??"")+1||1,this._safeBigIntEncoding=["number","bigint"].indexOf(i.encoding?.safeBigInt?.toLowerCase()??"")+1||1,this._nullEncoding=["atom","nil"].indexOf(i.encoding?.null?.toLowerCase()??"")+1||1,this._bufferEncoding=["binary","bitbinary","string"].indexOf(i.encoding?.buffer?.toLowerCase()??"")+1||1,this._undefinedEncoding=["atom","ignore"].indexOf(i.encoding?.undefined?.toLowerCase()??"")+1||1,this._infinityEncoding=["atom","ignore"].indexOf(i.encoding?.infinity?.toLowerCase()??"")+1||1,this._nanEncoding=["atom","ignore"].indexOf(i.encoding?.nan?.toLowerCase()??"")+1||1,this._arrayEncoding=["list","improperlist","tuple"].indexOf(i.encoding?.array?.toLowerCase()??"")+1||1,this._useLegacyAtoms=Boolean(i.useLegacyAtoms),this._poolSize=Number(i.poolSize)||1048576,this._u=new Uint8Array(this._poolSize),this._v=new DataView(this._u.buffer),this._i=0,this._o=0,"undefined"!=typeof process&&"string"==typeof process?.versions?.node)this._b=Buffer.from(this._u.buffer),this._e=(i,t)=>this._b.write(i,t),this._T=32,!0===this._compressor&&(this._compressor="zlib");else{const s=new TextEncoder;this._e=(i,t)=>s.encodeInto(i,this._u.subarray(t)).written??0,this._b=null,this._T=32,!0===this._compressor&&(this._compressor="compressionstream"),"object"==typeof navigator&&((i=navigator.userAgent).includes("Firefox")?this._T=128:i.includes("Chrome")&&(this._T=540))}if(this._compressor)if("zlib"===this._compressor){const t=require("zlib");this._z=i=>{i=t.deflateSync(i);return this._compressorOut(i)}}else if("compressionstream"===this._compressor)this._z=i=>{var t=new CompressionStream("deflate"),s=t.readable.getReader();const e=t.writable.getWriter();return e.ready.then(()=>e.write(i)).then(()=>e.ready).then(()=>e.close()),this._compressorStreamOut(s)};else if("function"==typeof this._compressor){const e=this._compressor;this._z=i=>{i=e(i);return i instanceof Promise?i.then(this._compressorOut):this._compressorOut(i)}}}pack(i){var t;return this._o=this._i,this._expand(10),this._z?(this._loop(i),t=this._u.subarray(this._o,this._i),this._z(t)):(this._u[this._i++]=131,this._loop(i),this._u.subarray(this._o,this._i))}_loop(t){const s=typeof t;switch(s){case"undefined":2!==this._undefinedEncoding&&(this._expand(11),this._u[this._i]=this._useLegacyAtoms?115:119,this._u[this._i+1]=9,this._u[this._i+2]=117,this._v.setUint32(this._i+3,1852073318),this._v.setUint32(this._i+7,1768842596),this._i+=11);break;case"boolean":this._expand(7),this._u[this._i]=this._useLegacyAtoms?115:119,t?(this._u[this._i+1]=4,this._v.setUint32(this._i+2,1953658213),this._i+=6):(this._u[this._i+1]=5,this._u[this._i+2]=102,this._v.setUint32(this._i+3,1634497381),this._i+=7);break;case"string":case"symbol":"symbol"===s&&(t=t.toString()),2===this._stringEncoding?(this._expand(2*t.length+5),this._u[this._i++]=109,h=this._i,this._i+=4,e=this._utf(t),this._v.setUint32(h,e)):(this._expand(2*t.length+3),this._u[this._i++]=107,h=this._i,this._i+=2,e=this._utf(t),this._u[h]=e>>8,this._u[h+1]=255&e);break;case"number":if(Number.isFinite(t))this._expand(11),Number.isInteger(t)?(h=Math.abs(t),e=t<0,t<256&&!e?(this._u[this._i++]=97,this._u[this._i++]=t):h<2147483648?(this._u[this._i]=98,this._v.setInt32(this._i+1,t),this._i+=5):h<=Number.MAX_SAFE_INTEGER&&1===this._safeIntEncoding?(this._u[this._i]=110,this._u[this._i+2]=Number(e),h<4294967296?(this._v.setUint32(this._i+3,h,!0),this._u[this._i+1]=4,this._i+=7):(e=h>>>0,h=Math.floor(h/4294967296),this._v.setUint32(this._i+3,e,!0),h<256?(this._u[this._i+1]=5,this._u[this._i+7]=h,this._i+=8):h<65536?(this._u[this._i+1]=6,this._u[this._i+7]=255&h,this._u[this._i+8]=h>>8,this._i+=9):(this._u[this._i+1]=7,this._u[this._i+7]=255&h,this._u[this._i+8]=h>>8&255,this._u[this._i+9]=h>>16,this._i+=10))):(this._u[this._i++]=70,this._v.setFloat64(this._i,t),this._i+=8)):(this._u[this._i++]=70,this._v.setFloat64(this._i,t),this._i+=8);else if(Number.isNaN(t)){if(this._expand(4),2===this._nanEncoding)break;this._u[this._i]=this._useLegacyAtoms?115:119,this._u[this._i+1]=110,this._u[this._i+2]=97,this._u[this._i+3]=110,this._i+=4}else{if(this._expand(18),2===this._infinityEncoding)break;this._u[this._i]=this._useLegacyAtoms?115:119,t<0?this._v.setUint32(this._i+1,1852139361):this._v.setUint32(this._i+1,1886352233),this._u[this._i+5]=95,this._v.setUint32(this._i+6,1769366879),this._v.setUint32(this._i+10,1768842857),this._v.setUint32(this._i+14,1852404857),this._i+=18}break;case"bigint":if(0n===t)this._expand(3),2===this._safeBigIntEncoding?(this._u[this._i++]=110,this._u[this._i++]=0):this._u[this._i++]=97,this._u[this._i++]=0;else{var e=t<0n,h=e?-t:t;if(h<18446744073709551616n)if(this._expand(11),1===this._safeBigIntEncoding&&h<2147483648n)this._u[this._i]=98,this._v.setBigUint64(this._i+1,h),e&&(f=this._u[this._i+1],this._u[this._i+1]=128|f),this._i+=5;else{this._u[this._i]=110,this._u[this._i+2]=Number(e),this._v.setBigUint64(this._i+3,h,!0);for(let i=10;3<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else if(h<340282366920938463463374607431768211456n){this._expand(19),this._u[this._i]=110,this._u[this._i+2]=Number(e),this._v.setBigUint64(this._i+3,18446744073709551615n&h,!0),this._v.setBigUint64(this._i+11,h>>64n,!0);for(let i=18;11<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else if(h<115792089237316195423570985008687907853269984665640564039457584007913129639936n){this._expand(35),this._u[this._i]=110,this._u[this._i+2]=Number(e),this._v.setBigUint64(this._i+3,18446744073709551615n&h,!0),this._v.setBigUint64(this._i+11,h>>64n&18446744073709551615n,!0),this._v.setBigUint64(this._i+19,h>>128n&18446744073709551615n,!0),this._v.setBigUint64(this._i+27,h>>192n,!0);for(let i=34;27<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else{let i=h;for(var _=[];;){var n=115792089237316195423570985008687907853269984665640564039457584007913129639935n&i,r=n>>128n,n=340282366920938463463374607431768211455n&n;if(!(i>>=256n)){var o=18446744073709551615n&n,a=n>>64n,u=18446744073709551615n&r,d=r>>64n;0n<d?_.push(o,a,u,d):0n<u?_.push(o,a,u):0n<a?_.push(o,a):_.push(o);break}_.push(18446744073709551615n&n,n>>64n,18446744073709551615n&r,r>>64n)}var f=8*_.length;this._expand(6+f),f<256?(this._u[this._i]=110,this._u[this._i+1]=f,this._u[this._i+2]=Number(e),this._i+=3):(this._u[this._i]=111,this._v.setUint32(this._i+1,f),this._u[this._i+5]=Number(e),this._i+=6);for(let i=0;i<_.length;i++){var c=_[i],g=this._i+8*i;this._v.setBigUint64(g,c,!0)}this._i+=f}}break;case"object":if(null===t)this._expand(5),2===this._nullEncoding?this._u[this._i++]=106:(this._u[this._i]=this._useLegacyAtoms?115:119,this._v.setUint32(this._i+1,57567596),this._i+=5);else if(Array.isArray(t))if(this._expand(5),0===t.length)3===this._arrayEncoding?(this._u[this._i++]=104,this._u[this._i++]=0):this._u[this._i++]=106;else{3===this._arrayEncoding?t.length<256?(this._u[this._i++]=104,this._u[this._i++]=t.length):(this._u[this._i]=105,this._v.setUint32(this._i+1,t.length),this._i+=5):(this._u[this._i]=108,this._v.setUint32(this._i+1,t.length-(2===this._arrayEncoding?1:0)),this._i+=5);for(const i of t)this._loop(i);2!==this._arrayEncoding&&(this._u[this._i++]=106)}else if(ArrayBuffer.isView(t)){var h=1!==t.BYTES_PER_ELEMENT?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t,e=h.length;let i=!1;3===this._bufferEncoding?(this._expand(e+3),this._u[this._i]=107,this._u[this._i+1]=e>>8,this._u[this._i+2]=255&e,this._i+=3):2===this._bufferEncoding?(this._expand(e+6),this._u[this._i]=77,this._v.setUint32(this._i+1,e),this._u[this._i+5]=0,this._i+=6,i=!0):(this._expand(e+5),this._u[this._i]=109,this._v.setUint32(this._i+1,e),this._i+=5),e&&(this._u.set(h,this._i),i)&&(f=this._u[this._i+e-1],h=Math.floor(Math.log2(f)+1),this._u[this._i+e-1]=f<<8-h,this._u[this._i-1]=h),this._i+=e}else{this._expand(6),this._u[this._i++]=116;var l=Object.keys(t);this._v.setUint32(this._i,l.length),this._i+=4;for(let i=0;i<l.length;i++){var b=l[i],v=t[b];const s=typeof v;if("undefined"!=s||2!==this._undefinedEncoding){if("number"==s&&!Number.isFinite(v))if(Number.isNaN(v)){if(2===this._nanEncoding)continue}else if(2===this._infinityEncoding)continue;var p=b.length;if(1===this._keyEncoding&&this._useLegacyAtoms){p<256?(this._expand(p+2),this._u[this._i++]=115,this._u[this._i++]=p):(this._expand(p+3),this._u[this._i++]=100,this._u[this._i++]=p>>8,this._u[this._i++]=255&p);for(let i=0;i<p;i++)this._u[this._i++]=b.charCodeAt(i)}else{var m=2*p;let i=0;this._expand(5+m),i=2===this._keyEncoding?(this._u[this._i]=109,4):3===this._keyEncoding?(this._u[this._i]=107,2):m<256?(this._u[this._i]=119,1):(this._u[this._i]=118,2);var m=this._i+1,y=(this._i+=i+1,this._utf(b));1===i?this._u[m]=y:2===i?(this._u[m]=y>>8,this._u[m+1]=255&y):this._v.setUint32(m,y)}this._loop(v)}}}}}_expand(i){if(this._i+i>=this._poolSize){let i;0===this._o?(this._poolSize*=2,i=this._u,this._u=new Uint8Array(this._poolSize)):(i=this._u.subarray(this._o,this._i),this._u=new Uint8Array(this._poolSize),this._i=i.length,this._o=0),this._v=new DataView(this._u.buffer),this._b&&(this._b=Buffer.from(this._u.buffer)),this._u.set(i)}}_utf(t){var s=t.length;if(s<this._T){var i=this._i;for(let i=0;i<s;i++){var e=t.charCodeAt(i);e<128?this._u[this._i++]=e:e<2048?(this._u[this._i++]=192+(e>>6),this._u[this._i++]=128+(63&e)):e<55296||57343<e?(this._u[this._i++]=224+(e>>12),this._u[this._i++]=128+(e>>6&63),this._u[this._i++]=128+(63&e)):(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),this._u[this._i++]=240+(e>>18),this._u[this._i++]=128+(e>>12&63),this._u[this._i++]=128+(e>>6&63),this._u[this._i++]=128+(63&e))}return this._i-i}return i=this._e(t,this._i),this._i+=i,i}_compressorOut(i){var t=i.length,s=new Uint8Array(t+6);return s[0]=131,s[1]=80,s[2]=t>>24,s[3]=t>>16&255,s[4]=t>>8&255,s[5]=255&t,s.set(i,6),s}async _compressorStreamOut(i){var t=[];let s=0;for(;;){var{done:e,value:h}=await i.read();if(h&&(t.push(h),s+=h.length),e)break}var _=new Uint8Array(s+6);_[0]=131,_[1]=80,_[2]=s>>24,_[3]=s>>16&255,_[4]=s>>8&255,_[5]=255&s;let n=6;for(let i=0;i<t.length;i++){var r=t[i];_.set(r,n),n+=r.length}return _}},i.Unpacker=class{constructor(i={}){var t,s;this._decompressor=i.decompression,this._nilDecoding=["null","array"].indexOf(i.decoding?.nil?.toLowerCase()??"")+1||1,this._stringDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.string?.toLowerCase()??"")+1||1,this._binaryDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.binary?.toLowerCase()??"")+1||4,this._bitbinaryDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.bitbinary?.toLowerCase()??"")+1||4,this._safebigintDecoding=["number","bigint","string"].indexOf(i.decoding?.safebigint?.toLowerCase()??"")+1||2,this._bigintDecoding=["bigint","string"].indexOf(i.decoding?.bigint?.toLowerCase()??"")+1||1,this._atomRegistration=Boolean(i.atomRegistration??!0),"undefined"!=typeof process&&"string"==typeof process?.versions?.node?(t=require("node:string_decoder")["StringDecoder"],s=new t("utf8"),t=new t("latin1"),this._u=s.write.bind(s),this._l=t.write.bind(t),this._T=15,this._decompressor||(this._decompressor="zlib")):(s=new TextDecoder("utf8"),t=new TextDecoder("latin1"),this._u=s.decode.bind(s),this._l=t.decode.bind(t),this._T=32,"object"==typeof navigator&&((s=navigator.userAgent).includes("Firefox")?this._T=4:s.includes("Chrome")&&(this._T=200)),this._decompressor||(this._decompressor="decompressionstream")),this._d=new Uint8Array(0),this._v=new DataView(this._d.buffer,this._d.byteOffset,this._d.length),this._sd=new Uint8Array(12e3),this._sv=new DataView(this._sd.buffer,this._sd.byteOffset,this._sd.length),this._i=0,this._atoms=i.atomTable??{true:!0,false:!1,undefined:void 0,null:null,nil:null,nan:NaN,infinity:1/0,positive_infinity:1/0,negative_infinity:-1/0};const n=new TextEncoder;this._atomTableLatin=Object.entries(this._atoms).reduce((i,t)=>{var[s,e]=t;let h=i[s.length]??=[];for(let i=0;i<s.length;i++){var _=s.charCodeAt(i);h=h[_]??=i===s.length-1?e:[]}return i},[]),this._atomTableUtf=Object.entries(this._atoms).reduce((i,t)=>{var[t,s]=t,e=n.encode(t);let h=i[e.length]??=[];for(let i=0;i<e.length;i++){var _=e[i];h=h[_]??=i===e.length-1?s:[]}return i},[])}unpack(i){var t=131===i[0]?1:0;if(80===i[t]){var s=(i[1+t]<<24)+(i[2+t]<<16)+(i[3+t]<<8)+i[4+t];const h=i.subarray(5+t,5+t+s);if("zlib"===this._decompressor)return s=require("zlib").inflateSync(h),this.unpack(s);if("decompressionstream"===this._decompressor){var s=new DecompressionStream("deflate"),e=s.readable.getReader();const _=s.writable.getWriter();return _.ready.then(()=>_.write(h)).then(()=>_.ready).then(()=>_.close()),this._decompressorStreamOut(e).then(i=>this.unpack(i))}if("function"==typeof this._decompressor)return(s=this._decompressor(h))instanceof Promise?s.then(i=>this.unpack(i)):this.unpack(s)}return this._i=t,i.length<=this._sd.length?(this._sd.set(i),this._d=this._sd,this._v=this._sv):(this._d=i,this._v=new DataView(i.buffer,i.byteOffset,i.length)),this._loop()}_loop(){var e=this._d[this._i++];switch(e){case 70:var s=this._v.getFloat64(this._i);return this._i+=8,s;case 97:return this._d[this._i++];case 98:var s=this._v.getInt32(this._i);return this._i+=4,s;case 100:case 115:case 118:case 119:var s=100===e||118===e?(this._d[this._i++]<<8)+this._d[this._i++]:this._d[this._i++];return this._resolveAtom(s,e<118);case 108:var t=this._v.getUint32(this._i),h=(this._i+=4,Array(t));for(let i=0;i<t;i++)h[i]=this._loop();return 106===this._d[this._i]?this._i++:h.push(this._loop()),h;case 106:return 2===this._nilDecoding?[]:null;case 107:case 109:case 77:{let t,i;if(107===e?(t=(this._d[this._i++]<<8)+this._d[this._i++],i=this._stringDecoding):109===e?(t=this._v.getUint32(this._i),i=this._binaryDecoding,this._i+=4):(t=this._v.getUint32(this._i),i=this._bitbinaryDecoding,s=this._d[this._i+4],n=this._d[this._i+t-1],this._d[this._i+t-1]=n>>8-s,this._i+=5),5!==i)return 2<i?(n=this._d.subarray(this._i,this._i+t),this._i+=t,3===i?((s=Buffer.allocUnsafe(t)).set(n),s):((s=new Uint8Array(t)).set(n),s)):2===i?this._latin(t):this._utf(t);var _=Array(t);for(let i=0;i<t;i++)_[i]=this._d[this._i+i];return this._i+=t,_}case 110:case 111:{let t;if(110===e?t=this._d[this._i++]:(t=this._v.getUint32(this._i),this._i+=4),0===t)return this._i+=1,3===this._safebigintDecoding?"0":1===this._safebigintDecoding?0:0n;if(1===t&&0===this._d[this._i+1])return this._i+=2,3===this._safebigintDecoding?"0":1===this._safebigintDecoding?0:0n;var n=this._d[this._i++];if(t<7||7===t&&this._d[this._i+6]<32){let i=0;return i=1===t?this._d[this._i]:2===t?(this._d[this._i+1]<<8)+this._d[this._i]:3===t?(this._d[this._i+2]<<16)+(this._d[this._i+1]<<8)+this._d[this._i]:4===t?this._v.getUint32(this._i,!0):5===t?4294967296*this._d[this._i+4]+this._v.getUint32(this._i,!0):6===t?4294967296*((this._d[this._i+5]<<8)+this._d[this._i+4])+this._v.getUint32(this._i,!0):4294967296*((this._d[this._i+6]<<16)+(this._d[this._i+5]<<8)+this._d[this._i+4])+this._v.getUint32(this._i,!0),this._i+=t,n&&(i=-i),3===this._safebigintDecoding?i.toString():1===this._safebigintDecoding?i:BigInt(i)}let s;if(8===t)s=this._v.getBigUint64(this._i,!0);else{let i=t;for(s=0n;0<i;)8<=i?s=(s<<=64n)+this._v.getBigUint64(this._i+(i-=8),!0):4<=i?s=(s<<=32n)+BigInt(this._v.getUint32(this._i+(i-=4),!0)):2<=i?s=(s<<=16n)+BigInt(this._v.getUint16(this._i+(i-=2),!0)):(s=(s<<=8n)+BigInt(this._d[this._i]),i--)}return this._i+=t,n&&(s=-s),2===this._bigintDecoding?s.toString():s}case 116:var r={},o=this._v.getUint32(this._i);this._i+=4;for(let i=0;i<o;i++)r[this._loop()]=this._loop();return r}throw console.log(this._d.slice(this._i-20,this._i+20)),new Error("Unexpected byte: "+e)}_resolveAtom(e,i){var h=i?this._atomTableUtf:this._atomTableLatin;if(e in h){let t=h[e],s=this._i;for(let i=0;i<e;i++){var _=this._d[s++];if(!(_ in t))break;if(i===e-1)return this._i+=e,t[_];t=t[_]}}return this._atomRegistration?this._registerAtom(e,i):i?this._utf(e):this._latin(e)}_registerAtom(t,s){var i=s?this._atomTableUtf:this._atomTableLatin;t in i||(i[t]=[]);let e=i[t],h=this._i;for(let i=0;i<t;i++){var _=this._d[h++];e=_ in e?e[_]:i===t-1?e[_]=s?this._utf(t):this._latin(t):e[_]=[]}return this._atoms[e]=e}_utf(i){let t="",s=this._i;var e=this._d;if(i<this._T)for(var h=s+i;s<h;){var _=this._d[s++];_<128?t+=String.fromCharCode(_):_<224?t+=String.fromCharCode(((31&_)<<6)+(63&e[s++])):_<240?t+=String.fromCharCode(((15&_)<<12)+((63&e[s++])<<6)+(63&e[s++])):(_=((7&_)<<18)+((63&e[s++])<<12)+((63&e[s++])<<6)+(63&e[s++]),t+=String.fromCharCode(55296+(_-65536>>10),55296+(_-65536&1023)))}else t=this._u(e.subarray(s,s+i));return this._i+=i,t}_latin(t){let s="";var e=this._i,h=this._d;if(t<this._T)for(let i=e;i<e+t;i++)s+=String.fromCharCode(h[i]);else s=this._l(h.subarray(e,e+t));return this._i+=t,s}async _decompressorStreamOut(i){var t=[];let s=0;for(;;){var{done:e,value:h}=await i.read();if(h&&(t.push(h),s+=h.length),e)break}var _=new Uint8Array(s);let n=0;for(let i=0;i<t.length;i++){var r=t[i];_.set(r,n),n+=r.length}return _}}});