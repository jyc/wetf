!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(i.Wetf=i.Wetf||{})}(this,function(i){"use strict";i.Unpacker=class{constructor(i={}){var t,e;this._decompressor=i.decompression,this._nilDecoding=["null","array"].indexOf(i.decoding?.nil?.toLowerCase()??"")+1||1,this._stringDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.string?.toLowerCase()??"")+1||1,this._binaryDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.binary?.toLowerCase()??"")+1||4,this._bitbinaryDecoding=["utf8","latin1","buffer","uint8array","array"].indexOf(i.decoding?.bitbinary?.toLowerCase()??"")+1||4,this._safebigintDecoding=["number","bigint","string"].indexOf(i.decoding?.safebigint?.toLowerCase()??"")+1||2,this._bigintDecoding=["bigint","string"].indexOf(i.decoding?.bigint?.toLowerCase()??"")+1||1,"undefined"!=typeof process&&"string"==typeof process?.versions?.node?(t=require("node:string_decoder")["StringDecoder"],e=new t("utf8"),t=new t("latin1"),this._u=e.write.bind(e),this._l=t.write.bind(t),this._T=15,this._decompressor||(this._decompressor="zlib")):(e=new TextDecoder("utf8"),t=new TextDecoder("latin1"),this._u=e.decode.bind(e),this._l=t.decode.bind(t),this._T=32,"object"==typeof navigator&&((e=navigator.userAgent).includes("Firefox")?this._T=4:e.includes("Chrome")&&(this._T=200)),this._decompressor||(this._decompressor="decompressionstream")),this._d=new Uint8Array(0),this._v=new DataView(this._d.buffer,this._d.byteOffset,this._d.length),this._sd=new Uint8Array(12e3),this._sv=new DataView(this._sd.buffer,this._sd.byteOffset,this._sd.length),this._i=0,this._atoms=i.atomTable??{true:!0,false:!1,undefined:void 0,null:null,nil:null,nan:NaN,infinity:1/0,positive_infinity:1/0,negative_infinity:-1/0};const h=new TextEncoder;this._atomTableLatin=Object.entries(this._atoms).reduce((i,t)=>{var[e,s]=t;let r=i[e.length]??=[];for(let i=0;i<e.length;i++){var n=e.charCodeAt(i);r=r[n]??=i===e.length-1?s:[]}return i},[]),this._atomTableUtf=Object.entries(this._atoms).reduce((i,t)=>{var[t,e]=t,s=h.encode(t);let r=i[s.length]??=[];for(let i=0;i<s.length;i++){var n=s[i];r=r[n]??=i===s.length-1?e:[]}return i},[])}unpack(i){var t=131===i[0]?1:0;if(80===i[t]){var e=(i[1+t]<<24)+(i[2+t]<<16)+(i[3+t]<<8)+i[4+t];const r=i.subarray(5+t,5+t+e);if("zlib"===this._decompressor)return e=require("zlib").inflateSync(r),this.unpack(e);if("decompressionstream"===this._decompressor){var e=new DecompressionStream("deflate"),s=e.readable.getReader();const n=e.writable.getWriter();return n.ready.then(()=>n.write(r)).then(()=>n.ready).then(()=>n.close()),this._decompressorStreamOut(s).then(i=>this.unpack(i))}if("function"==typeof this._decompressor)return(e=this._decompressor(r))instanceof Promise?e.then(i=>this.unpack(i)):this.unpack(e)}return this._i=t,i.length<=this._sd.length?(this._sd.set(i),this._d=this._sd,this._v=this._sv):(this._d=i,this._v=new DataView(i.buffer,i.byteOffset,i.length)),this._loop()}_loop(){var s=this._d[this._i++];switch(s){case 70:var e=this._v.getFloat64(this._i);return this._i+=8,e;case 97:return this._d[this._i++];case 98:var e=this._v.getInt32(this._i);return this._i+=4,e;case 100:case 115:case 118:case 119:var e=100===s||118===s?(this._d[this._i++]<<8)+this._d[this._i++]:this._d[this._i++];return this._resolveAtom(e,s<118);case 108:var t=this._v.getUint32(this._i),r=(this._i+=4,Array(t));for(let i=0;i<t;i++)r[i]=this._loop();return 106===this._d[this._i]?this._i++:r.push(this._loop()),r;case 106:return 2===this._nilDecoding?[]:null;case 107:case 109:case 77:{let t,i;if(107===s?(t=(this._d[this._i++]<<8)+this._d[this._i++],i=this._stringDecoding):109===s?(t=this._v.getUint32(this._i),i=this._binaryDecoding,this._i+=4):(t=this._v.getUint32(this._i),i=this._bitbinaryDecoding,e=this._d[this._i+4],h=this._d[this._i+t-1],this._d[this._i+t-1]=h>>8-e,this._i+=5),5!==i)return 2<i?(h=this._d.subarray(this._i,this._i+t),this._i+=t,3===i?((e=Buffer.allocUnsafe(t)).set(h),e):((e=new Uint8Array(t)).set(h),e)):2===i?this._latin(t):this._utf(t);var n=Array(t);for(let i=0;i<t;i++)n[i]=this._d[this._i+i];return this._i+=t,n}case 110:case 111:{let t;if(110===s?t=this._d[this._i++]:(t=this._v.getUint32(this._i),this._i+=4),0===t)return this._i+=1,3===this._safebigintDecoding?"0":1===this._safebigintDecoding?0:0n;if(1===t&&0===this._d[this._i+1])return this._i+=2,3===this._safebigintDecoding?"0":1===this._safebigintDecoding?0:0n;var h=this._d[this._i++];if(t<7||7===t&&this._d[this._i+6]<32){let i=0;return i=1===t?this._d[this._i]:2===t?(this._d[this._i+1]<<8)+this._d[this._i]:3===t?(this._d[this._i+2]<<16)+(this._d[this._i+1]<<8)+this._d[this._i]:4===t?this._v.getUint32(this._i,!0):5===t?4294967296*this._d[this._i+4]+this._v.getUint32(this._i,!0):6===t?4294967296*((this._d[this._i+5]<<8)+this._d[this._i+4])+this._v.getUint32(this._i,!0):4294967296*((this._d[this._i+6]<<16)+(this._d[this._i+5]<<8)+this._d[this._i+4])+this._v.getUint32(this._i,!0),this._i+=t,h&&(i=-i),3===this._safebigintDecoding?i.toString():1===this._safebigintDecoding?i:BigInt(i)}let e;if(8===t)e=this._v.getBigUint64(this._i,!0);else{let i=t;for(e=0n;0<i;)8<=i?e=(e<<=64n)+this._v.getBigUint64(this._i+(i-=8),!0):4<=i?e=(e<<=32n)+BigInt(this._v.getUint32(this._i+(i-=4),!0)):2<=i?e=(e<<=16n)+BigInt(this._v.getUint16(this._i+(i-=2),!0)):(e=(e<<=8n)+BigInt(this._d[this._i]),i--)}return this._i+=t,h&&(e=-e),2===this._bigintDecoding?e.toString():e}case 116:var _={},a=this._v.getUint32(this._i);this._i+=4;for(let i=0;i<a;i++)_[this._loop()]=this._loop();return _}throw new Error("Missing etf type: "+s)}_resolveAtom(s,i){var r=i?this._atomTableUtf:this._atomTableLatin;if(s in r){let t=r[s],e=this._i;for(let i=0;i<s;i++){var n=this._d[e++];if(!(n in t))break;if(i===s-1)return this._i+=s,t[n];t=t[n]}}return i?this._utf(s):this._latin(s)}_utf(i){let t="",e=this._i;var s=this._d;if(i<this._T)for(var r=e+i;e<r;){var n=this._d[e++];n<128?t+=String.fromCharCode(n):n<224?t+=String.fromCharCode(((31&n)<<6)+(63&s[e++])):n<240?t+=String.fromCharCode(((15&n)<<12)+((63&s[e++])<<6)+(63&s[e++])):(n=((7&n)<<18)+((63&s[e++])<<12)+((63&s[e++])<<6)+(63&s[e++]),t+=String.fromCharCode(55296+(n-65536>>10),55296+(n-65536&1023)))}else t=this._u(s.subarray(e,e+i));return this._i+=i,t}_latin(t){let e="";var s=this._i,r=this._d;if(t<this._T)for(let i=s;i<s+t;i++)e+=String.fromCharCode(r[i]);else e=this._l(r.subarray(s,s+t));return this._i+=t,e}async _decompressorStreamOut(i){var t=[];let e=0;for(;;){var{done:s,value:r}=await i.read();if(r&&(t.push(r),e+=r.length),s)break}var n=new Uint8Array(e);let h=0;for(let i=0;i<t.length;i++){var _=t[i];n.set(_,h),h+=_.length}return n}}});