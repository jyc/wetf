!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(i.Wetf=i.Wetf||{})}(this,function(i){"use strict";i.Packer=class{constructor(i={}){if(this._compressor=i.compression??!1,this._stringEncoding=["string","binary"].indexOf(i.encoding?.string?.toLowerCase()??"")+1||1,this._keyEncoding=["atom","binary","string"].indexOf(i.encoding?.key?.toLowerCase()??"")+1||1,this._safeIntEncoding=["bigint","float"].indexOf(i.encoding?.safeInt?.toLowerCase()??"")+1||1,this._safeBigIntEncoding=["number","bigint"].indexOf(i.encoding?.safeBigInt?.toLowerCase()??"")+1||1,this._nullEncoding=["atom","nil"].indexOf(i.encoding?.null?.toLowerCase()??"")+1||1,this._bufferEncoding=["binary","bitbinary","string"].indexOf(i.encoding?.buffer?.toLowerCase()??"")+1||1,this._undefinedEncoding=["atom","ignore"].indexOf(i.encoding?.undefined?.toLowerCase()??"")+1||1,this._infinityEncoding=["atom","ignore"].indexOf(i.encoding?.infinity?.toLowerCase()??"")+1||1,this._nanEncoding=["atom","ignore"].indexOf(i.encoding?.nan?.toLowerCase()??"")+1||1,this._arrayEncoding=["list","improperlist","tuple"].indexOf(i.encoding?.array?.toLowerCase()??"")+1||1,this._useLegacyAtoms=Boolean(i.useLegacyAtoms),this._poolSize=Number(i.poolSize)||1048576,this._u=new Uint8Array(this._poolSize),this._v=new DataView(this._u.buffer),this._i=0,this._o=0,"undefined"!=typeof process&&"string"==typeof process?.versions?.node)this._b=Buffer.from(this._u.buffer),this._e=(i,t)=>this._b.write(i,t),this._T=32,!0===this._compressor&&(this._compressor="zlib");else{const s=new TextEncoder;this._e=(i,t)=>s.encodeInto(i,this._u.subarray(t)).written??0,this._b=null,this._T=32,!0===this._compressor&&(this._compressor="compressionstream"),"object"==typeof navigator&&((i=navigator.userAgent).includes("Firefox")?this._T=128:i.includes("Chrome")&&(this._T=540))}if(this._compressor)if("zlib"===this._compressor){const t=require("zlib");this._z=i=>{i=t.deflateSync(i);return this._compressorOut(i)}}else if("compressionstream"===this._compressor)this._z=i=>{var t=new CompressionStream("deflate"),s=t.readable.getReader();const h=t.writable.getWriter();return h.ready.then(()=>h.write(i)).then(()=>h.ready).then(()=>h.close()),this._compressorStreamOut(s)};else if("function"==typeof this._compressor){const h=this._compressor;this._z=i=>{i=h(i);return i instanceof Promise?i.then(this._compressorOut):this._compressorOut(i)}}}pack(i){var t;return this._o=this._i,this._expand(10),this._z?(this._loop(i),t=this._u.subarray(this._o,this._i),this._z(t)):(this._u[this._i++]=131,this._loop(i),this._u.subarray(this._o,this._i))}_loop(t){const s=typeof t;switch(s){case"undefined":2!==this._undefinedEncoding&&(this._expand(11),this._u[this._i]=this._useLegacyAtoms?115:119,this._u[this._i+1]=9,this._u[this._i+2]=117,this._v.setUint32(this._i+3,1852073318),this._v.setUint32(this._i+7,1768842596),this._i+=11);break;case"boolean":this._expand(7),this._u[this._i]=this._useLegacyAtoms?115:119,t?(this._u[this._i+1]=4,this._v.setUint32(this._i+2,1953658213),this._i+=6):(this._u[this._i+1]=5,this._u[this._i+2]=102,this._v.setUint32(this._i+3,1634497381),this._i+=7);break;case"string":case"symbol":"symbol"===s&&(t=t.toString()),2===this._stringEncoding?(this._expand(2*t.length+5),this._u[this._i++]=109,_=this._i,this._i+=4,h=this._utf(t),this._v.setUint32(_,h)):(this._expand(2*t.length+3),this._u[this._i++]=107,_=this._i,this._i+=2,h=this._utf(t),this._u[_]=h>>8,this._u[_+1]=255&h);break;case"number":if(Number.isFinite(t))this._expand(11),Number.isInteger(t)?(_=Math.abs(t),h=t<0,t<256&&!h?(this._u[this._i++]=97,this._u[this._i++]=t):_<2147483648?(this._u[this._i]=98,this._v.setInt32(this._i+1,t),this._i+=5):_<=Number.MAX_SAFE_INTEGER&&1===this._safeIntEncoding?(this._u[this._i]=110,this._u[this._i+2]=Number(h),_<4294967296?(this._v.setUint32(this._i+3,_,!0),this._u[this._i+1]=4,this._i+=7):(h=_>>>0,_=Math.floor(_/4294967296),this._v.setUint32(this._i+3,h,!0),_<256?(this._u[this._i+1]=5,this._u[this._i+7]=_,this._i+=8):_<65536?(this._u[this._i+1]=6,this._u[this._i+7]=255&_,this._u[this._i+8]=_>>8,this._i+=9):(this._u[this._i+1]=7,this._u[this._i+7]=255&_,this._u[this._i+8]=_>>8&255,this._u[this._i+9]=_>>16,this._i+=10))):(this._u[this._i++]=70,this._v.setFloat64(this._i,t),this._i+=8)):(this._u[this._i++]=70,this._v.setFloat64(this._i,t),this._i+=8);else if(Number.isNaN(t)){if(this._expand(4),2===this._nanEncoding)break;this._u[this._i]=this._useLegacyAtoms?115:119,this._u[this._i+1]=110,this._u[this._i+2]=97,this._u[this._i+3]=110,this._i+=4}else{if(this._expand(18),2===this._infinityEncoding)break;this._u[this._i]=this._useLegacyAtoms?115:119,t<0?this._v.setUint32(this._i+1,1852139361):this._v.setUint32(this._i+1,1886352233),this._u[this._i+5]=95,this._v.setUint32(this._i+6,1769366879),this._v.setUint32(this._i+10,1768842857),this._v.setUint32(this._i+14,1852404857),this._i+=18}break;case"bigint":if(0n===t)this._expand(3),2===this._safeBigIntEncoding?(this._u[this._i++]=110,this._u[this._i++]=0):this._u[this._i++]=97,this._u[this._i++]=0;else{var h=t<0n,_=h?-t:t;if(_<18446744073709551616n)if(this._expand(11),1===this._safeBigIntEncoding&&_<2147483648n)this._u[this._i]=98,this._v.setBigUint64(this._i+1,_),h&&(c=this._u[this._i+1],this._u[this._i+1]=128|c),this._i+=5;else{this._u[this._i]=110,this._u[this._i+2]=Number(h),this._v.setBigUint64(this._i+3,_,!0);for(let i=10;3<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else if(_<340282366920938463463374607431768211456n){this._expand(19),this._u[this._i]=110,this._u[this._i+2]=Number(h),this._v.setBigUint64(this._i+3,18446744073709551615n&_,!0),this._v.setBigUint64(this._i+11,_>>64n,!0);for(let i=18;11<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else if(_<115792089237316195423570985008687907853269984665640564039457584007913129639936n){this._expand(35),this._u[this._i]=110,this._u[this._i+2]=Number(h),this._v.setBigUint64(this._i+3,18446744073709551615n&_,!0),this._v.setBigUint64(this._i+11,_>>64n&18446744073709551615n,!0),this._v.setBigUint64(this._i+19,_>>128n&18446744073709551615n,!0),this._v.setBigUint64(this._i+27,_>>192n,!0);for(let i=34;27<i;i--)if(0!==this._u[this._i+i]){this._u[this._i+1]=i-2,this._i+=i+1;break}}else{let i=_;for(var e=[];;){var n=115792089237316195423570985008687907853269984665640564039457584007913129639935n&i,r=n>>128n,n=340282366920938463463374607431768211455n&n;if(!(i>>=256n)){var o=18446744073709551615n&n,u=n>>64n,a=18446744073709551615n&r,f=r>>64n;0n<f?e.push(o,u,a,f):0n<a?e.push(o,u,a):0n<u?e.push(o,u):e.push(o);break}e.push(18446744073709551615n&n,n>>64n,18446744073709551615n&r,r>>64n)}var c=8*e.length;this._expand(6+c),c<256?(this._u[this._i]=110,this._u[this._i+1]=c,this._u[this._i+2]=Number(h),this._i+=3):(this._u[this._i]=111,this._v.setUint32(this._i+1,c),this._u[this._i+5]=Number(h),this._i+=6);for(let i=0;i<e.length;i++){var d=e[i],g=this._i+8*i;this._v.setBigUint64(g,d,!0)}this._i+=c}}break;case"object":if(null===t)this._expand(5),2===this._nullEncoding?this._u[this._i++]=106:(this._u[this._i]=this._useLegacyAtoms?115:119,this._v.setUint32(this._i+1,57567596),this._i+=5);else if(Array.isArray(t))if(this._expand(5),0===t.length)3===this._arrayEncoding?(this._u[this._i++]=104,this._u[this._i++]=0):this._u[this._i++]=106;else{3===this._arrayEncoding?t.length<256?(this._u[this._i++]=104,this._u[this._i++]=t.length):(this._u[this._i]=105,this._v.setUint32(this._i+1,t.length),this._i+=5):(this._u[this._i]=108,this._v.setUint32(this._i+1,t.length-(2===this._arrayEncoding?1:0)),this._i+=5);for(const i of t)this._loop(i);2!==this._arrayEncoding&&(this._u[this._i++]=106)}else if(ArrayBuffer.isView(t)){var _=1!==t.BYTES_PER_ELEMENT?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t,h=_.length;let i=!1;3===this._bufferEncoding?(this._expand(h+3),this._u[this._i]=107,this._u[this._i+1]=h>>8,this._u[this._i+2]=255&h,this._i+=3):2===this._bufferEncoding?(this._expand(h+6),this._u[this._i]=77,this._v.setUint32(this._i+1,h),this._u[this._i+5]=0,this._i+=6,i=!0):(this._expand(h+5),this._u[this._i]=109,this._v.setUint32(this._i+1,h),this._i+=5),h&&(this._u.set(_,this._i),i)&&(c=this._u[this._i+h-1],_=Math.floor(Math.log2(c)+1),this._u[this._i+h-1]=c<<8-_,this._u[this._i-1]=_),this._i+=h}else{this._expand(6),this._u[this._i++]=116;var l=Object.keys(t);this._v.setUint32(this._i,l.length),this._i+=4;for(let i=0;i<l.length;i++){var p=l[i],b=t[p];const s=typeof b;if("undefined"!=s||2!==this._undefinedEncoding){if("number"==s&&!Number.isFinite(b))if(Number.isNaN(b)){if(2===this._nanEncoding)continue}else if(2===this._infinityEncoding)continue;var m=p.length;if(1===this._keyEncoding&&this._useLegacyAtoms){m<256?(this._expand(m+2),this._u[this._i++]=115,this._u[this._i++]=m):(this._expand(m+3),this._u[this._i++]=100,this._u[this._i++]=m>>8,this._u[this._i++]=255&m);for(let i=0;i<m;i++)this._u[this._i++]=p.charCodeAt(i)}else{var v=2*m;let i=0;this._expand(5+v),i=2===this._keyEncoding?(this._u[this._i]=109,4):3===this._keyEncoding?(this._u[this._i]=107,2):v<256?(this._u[this._i]=119,1):(this._u[this._i]=118,2);var v=this._i+1,y=(this._i+=i+1,this._utf(p));1===i?this._u[v]=y:2===i?(this._u[v]=y>>8,this._u[v+1]=255&y):this._v.setUint32(v,y)}this._loop(b)}}}}}_expand(i){if(this._i+i>=this._poolSize){let i;0===this._o?(this._poolSize*=2,i=this._u,this._u=new Uint8Array(this._poolSize)):(i=this._u.subarray(this._o,this._i),this._u=new Uint8Array(this._poolSize),this._i=i.length,this._o=0),this._v=new DataView(this._u.buffer),this._b&&(this._b=Buffer.from(this._u.buffer)),this._u.set(i)}}_utf(t){var s=t.length;if(s<this._T){var i=this._i;for(let i=0;i<s;i++){var h=t.charCodeAt(i);h<128?this._u[this._i++]=h:h<2048?(this._u[this._i++]=192+(h>>6),this._u[this._i++]=128+(63&h)):h<55296||57343<h?(this._u[this._i++]=224+(h>>12),this._u[this._i++]=128+(h>>6&63),this._u[this._i++]=128+(63&h)):(h=65536+((1023&h)<<10)+(1023&t.charCodeAt(++i)),this._u[this._i++]=240+(h>>18),this._u[this._i++]=128+(h>>12&63),this._u[this._i++]=128+(h>>6&63),this._u[this._i++]=128+(63&h))}return this._i-i}return i=this._e(t,this._i),this._i+=i,i}_compressorOut(i){var t=i.length,s=new Uint8Array(t+6);return s[0]=131,s[1]=80,s[2]=t>>24,s[3]=t>>16&255,s[4]=t>>8&255,s[5]=255&t,s.set(i,6),s}async _compressorStreamOut(i){var t=[];let s=0;for(;;){var{done:h,value:_}=await i.read();if(_&&(t.push(_),s+=_.length),h)break}var e=new Uint8Array(s+6);e[0]=131,e[1]=80,e[2]=s>>24,e[3]=s>>16&255,e[4]=s>>8&255,e[5]=255&s;let n=6;for(let i=0;i<t.length;i++){var r=t[i];e.set(r,n),n+=r.length}return e}}});