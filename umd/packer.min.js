!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i("undefined"!=typeof globalThis?globalThis:t||self)}(this,function(t){"use strict";(t.Wetf||(t.Wetf={})).Packer=class{constructor(t={}){if(this.t=t.compression??!1,this.i=["string","binary"].indexOf(t.encoding?.string?.toLowerCase()??"")+1||1,this.h=["atom","binary","string"].indexOf(t.encoding?.key?.toLowerCase()??"")+1||1,this.l=["bigint","float"].indexOf(t.encoding?.safeInt?.toLowerCase()??"")+1||1,this.o=["number","bigint"].indexOf(t.encoding?.safeBigInt?.toLowerCase()??"")+1||1,this.u=["atom","nil"].indexOf(t.encoding?.null?.toLowerCase()??"")+1||1,this.m=["binary","bitbinary","string"].indexOf(t.encoding?.buffer?.toLowerCase()??"")+1||1,this.v=["atom","null","ignore"].indexOf(t.encoding?.undefined?.toLowerCase()??"")+1||1,this.p=["atom","null","ignore"].indexOf(t.encoding?.infinity?.toLowerCase()??"")+1||1,this.g=["atom","null","ignore"].indexOf(t.encoding?.nan?.toLowerCase()??"")+1||1,this.k=["list","improperlist","tuple"].indexOf(t.encoding?.array?.toLowerCase()??"")+1||3,this.N=Boolean(t.useLegacyAtoms),this.A=Number(t.poolSize)||1048576,this.U=new Uint8Array(this.A),this.j=new DataView(this.U.buffer),this.B=0,this.M=0,this.T=0,"undefined"!=typeof process&&"string"==typeof process?.versions?.node)this.V=Buffer.from(this.U.buffer),this.q=(t,i)=>this.V.write(t,i),this.C=32,!0===this.t&&(this.t="zlib");else{const s=new TextEncoder;this.q=(t,i)=>s.encodeInto(t,this.U.subarray(i)).written??0,this.V=null,this.C=32,!0===this.t&&(this.t="compressionstream"),"object"==typeof navigator&&((t=navigator.userAgent).includes("Firefox")?this.C=128:t.includes("Chrome")&&(this.C=540))}if(this.t)if("zlib"===this.t){const i=require("zlib");this.D=t=>(t=i.deflateSync(t),this.F(t))}else if("compressionstream"===this.t)this.D=t=>{var i=new CompressionStream("deflate"),s=i.readable.getReader();const h=i.writable.getWriter();return h.ready.then(()=>h.write(t)).then(()=>h.ready).then(()=>h.close()),this.S(s)};else if("function"==typeof this.t){const h=this.t;this.D=t=>(t=h(t))instanceof Promise?t.then(this.F):this.F(t)}}pack(t){var i;return this.M=this.B,this.T=0,this.I(10),this.D?(this.O(t),i=this.U.subarray(this.M,this.B),this.D(i)):(this.U[this.B++]=131,this.O(t),this.U.subarray(this.M,this.B))}O(h){var t=typeof h;switch(t){case"undefined":3!==this.v&&(this.I(11),this.U[this.B]=this.N?115:119,this.U[this.B+1]=9,this.U[this.B+2]=117,this.j.setUint32(this.B+3,1852073318),this.j.setUint32(this.B+7,1768842596),this.B+=11);break;case"boolean":this.I(7),this.U[this.B]=this.N?115:119,h?(this.U[this.B+1]=4,this.j.setUint32(this.B+2,1953658213),this.B+=6):(this.U[this.B+1]=5,this.U[this.B+2]=102,this.j.setUint32(this.B+3,1634497381),this.B+=7);break;case"string":case"symbol":"symbol"==t&&(h=h.toString()),2===this.i?(this.I(2*h.length+5),this.U[this.B++]=109,e=this.B,this.B+=4,m=this.P(h),this.j.setUint32(e,m)):(this.I(2*h.length+3),this.U[this.B++]=107,e=this.B,this.B+=2,m=this.P(h),this.U[e]=m>>8,this.U[e+1]=255&m);break;case"number":if(Number.isFinite(h))this.I(11),Number.isInteger(h)?(e=Math.abs(h),m=h<0,h<256&&!m?(this.U[this.B++]=97,this.U[this.B++]=h):e<2147483648?(this.U[this.B]=98,this.j.setInt32(this.B+1,h),this.B+=5):e<=Number.MAX_SAFE_INTEGER&&1===this.l?(this.U[this.B]=110,this.U[this.B+2]=Number(m),e<4294967296?(this.j.setUint32(this.B+3,e,!0),this.U[this.B+1]=4,this.B+=7):(m=e>>>0,e=Math.floor(e/4294967296),this.j.setUint32(this.B+3,m,!0),e<256?(this.U[this.B+1]=5,this.U[this.B+7]=e,this.B+=8):e<65536?(this.U[this.B+1]=6,this.U[this.B+7]=255&e,this.U[this.B+8]=e>>8,this.B+=9):(this.U[this.B+1]=7,this.U[this.B+7]=255&e,this.U[this.B+8]=e>>8&255,this.U[this.B+9]=e>>16,this.B+=10))):(this.U[this.B++]=70,this.j.setFloat64(this.B,h),this.B+=8)):(this.U[this.B++]=70,this.j.setFloat64(this.B,h),this.B+=8);else if(Number.isNaN(h)){if(3===this.g)break;this.I(4),this.U[this.B]=this.N?115:119,this.U[this.B+1]=110,this.U[this.B+2]=97,this.U[this.B+3]=110,this.B+=4}else{if(3===this.p)break;this.I(18),this.U[this.B]=this.N?115:119,h<0?this.j.setUint32(this.B+1,1852139361):this.j.setUint32(this.B+1,1886352233),this.U[this.B+5]=95,this.j.setUint32(this.B+6,1769366879),this.j.setUint32(this.B+10,1768842857),this.j.setUint32(this.B+14,1852404857),this.B+=18}break;case"bigint":if(0n===h)this.I(3),2===this.o?(this.U[this.B++]=110,this.U[this.B++]=0):this.U[this.B++]=97,this.U[this.B++]=0;else{var e=(m=h<0n)?-h:h;if(e<18446744073709551616n)if(this.I(11),1===this.o&&e<2147483648n)e<256n&&!m?(this.U[this.B++]=97,this.j.setBigUint64(this.B++,e)):(this.U[this.B++]=98,this.j.setBigUint64(this.B,e),m&&(o=this.U[this.B],this.U[this.B]=128|o),this.B+=4);else{this.U[this.B]=110,this.U[this.B+2]=Number(m),this.j.setBigUint64(this.B+3,e,!0);for(let t=10;3<t;t--)if(0!==this.U[this.B+t]){this.U[this.B+1]=t-2,this.B+=t+1;break}}else if(e<340282366920938463463374607431768211456n){this.I(19),this.U[this.B]=110,this.U[this.B+2]=Number(m),this.j.setBigUint64(this.B+3,18446744073709551615n&e,!0),this.j.setBigUint64(this.B+11,e>>64n,!0);for(let t=18;11<t;t--)if(0!==this.U[this.B+t]){this.U[this.B+1]=t-2,this.B+=t+1;break}}else if(e<115792089237316195423570985008687907853269984665640564039457584007913129639936n){this.I(35),this.U[this.B]=110,this.U[this.B+2]=Number(m),this.j.setBigUint64(this.B+3,18446744073709551615n&e,!0),this.j.setBigUint64(this.B+11,e>>64n&18446744073709551615n,!0),this.j.setBigUint64(this.B+19,e>>128n&18446744073709551615n,!0),this.j.setBigUint64(this.B+27,e>>192n,!0);for(let t=34;27<t;t--)if(0!==this.U[this.B+t]){this.U[this.B+1]=t-2,this.B+=t+1;break}}else{let t=e;for(var i=[];;){var s=(r=115792089237316195423570985008687907853269984665640564039457584007913129639935n&t)>>128n,r=340282366920938463463374607431768211455n&r;if(!(t>>=256n)){var n=18446744073709551615n&r,a=r>>64n,f=18446744073709551615n&s,l=s>>64n;0n<l?i.push(n,a,f,l):0n<f?i.push(n,a,f):0n<a?i.push(n,a):i.push(n);break}i.push(18446744073709551615n&r,r>>64n,18446744073709551615n&s,s>>64n)}var o=8*i.length;this.I(6+o),o<256?(this.U[this.B]=110,this.U[this.B+1]=o,this.U[this.B+2]=Number(m),this.B+=3):(this.U[this.B]=111,this.j.setUint32(this.B+1,o),this.U[this.B+5]=Number(m),this.B+=6);for(let t=0;t<i.length;t++){var u=i[t],b=this.B+8*t;this.j.setBigUint64(b,u,!0)}this.B+=o}}break;case"object":if(null===h)this.I(5),2===this.u?this.U[this.B++]=106:(this.U[this.B]=this.N?115:119,this.j.setUint32(this.B+1,57567596),this.B+=5);else if(Array.isArray(h))if(this.I(5),0===h.length)3===this.k?(this.U[this.B++]=104,this.U[this.B++]=0):this.U[this.B++]=106;else{let s=h.length,t=this.B+1,i=1;e=this.T,3===this.k?h.length<256?(this.U[this.B]=104,this.B+=2):(this.U[this.B]=105,this.B+=5,i=2):(this.U[this.B]=108,this.B+=5,i=2===this.k?(s--,3):4);for(let i=0;i<h.length;i++){let t=h[i];var c=this.G(t);if(!c){if(null!==c){s--;continue}t=null}this.O(t)}switch(e!==this.T&&(t-=this.T),i){case 1:this.U[t]=s;break;case 2:case 3:this.j.setUint32(t,s);break;case 4:this.j.setUint32(t,s),this.U[this.B++]=106}}else if(ArrayBuffer.isView(h)){var m,o=(m=1!==h.BYTES_PER_ELEMENT?new Uint8Array(h.buffer,h.byteOffset,h.byteLength):h).length;let t=!1;3===this.m?(this.I(o+3),this.U[this.B]=107,this.U[this.B+1]=o>>8,this.U[this.B+2]=255&o,this.B+=3):2===this.m?(this.I(o+6),this.U[this.B]=77,this.j.setUint32(this.B+1,o),this.U[this.B+5]=0,this.B+=6,t=!0):(this.I(o+5),this.U[this.B]=109,this.j.setUint32(this.B+1,o),this.B+=5),o&&(this.U.set(m,this.B),t)&&(e=this.U[this.B+o-1],m=Math.floor(Math.log2(e)+1),this.U[this.B+o-1]=e<<8-m,this.U[this.B-1]=m),this.B+=o}else{this.I(6),this.U[this.B++]=116;var v=Object.keys(h);let s=v.length,t=this.B;e=this.T,this.B+=4;for(let i=0;i<v.length;i++){var y=v[i];let t=h[y];if(!(g=this.G(t))){if(null!==g){s--;continue}t=null}var p=y.length;if(1===this.h&&this.N){p<256?(this.I(p+2),this.U[this.B++]=115,this.U[this.B++]=p):(this.I(p+3),this.U[this.B++]=100,this.U[this.B++]=p>>8,this.U[this.B++]=255&p);for(let t=0;t<p;t++)this.U[this.B++]=y.charCodeAt(t)}else{this.I(5+(g=2*p)),d=2===this.h?(this.U[this.B]=109,4):3===this.h?(this.U[this.B]=107,2):g<256?(this.U[this.B]=119,1):(this.U[this.B]=118,2);var d,g=this.B+1,k=(this.B+=1+d,this.P(y));1==d?this.U[g]=k:2==d?(this.U[g]=k>>8,this.U[g+1]=255&k):this.j.setUint32(g,k)}this.O(t)}e!==this.T&&(t-=this.T),this.j.setUint32(t,s)}}}G(t){var i=typeof t;if("undefined"==i){if(2===this.v)return null;if(3===this.v)return!1}if("number"==i&&!Number.isFinite(t))if(Number.isNaN(t)){if(2===this.g)return null;if(3===this.g)return!1}else{if(2===this.p)return null;if(3===this.p)return!1}return!0}I(t){if(this.B+t>=this.A){let t;0===this.M?(this.A*=2,t=this.U,this.U=new Uint8Array(this.A)):(t=this.U.subarray(this.M,this.B),this.U=new Uint8Array(this.A),this.B=t.length,this.T=this.M,this.M=0),this.j=new DataView(this.U.buffer),this.V&&(this.V=Buffer.from(this.U.buffer)),this.U.set(t)}}P(i){var s=i.length;if(s<this.C){var t=this.B;for(let t=0;t<s;t++){var h=i.charCodeAt(t);h<128?this.U[this.B++]=h:(h<2048?this.U[this.B++]=192+(h>>6):(h<55296||57343<h?this.U[this.B++]=224+(h>>12):(h=65536+((1023&h)<<10)+(1023&i.charCodeAt(++t)),this.U[this.B++]=240+(h>>18),this.U[this.B++]=128+(h>>12&63)),this.U[this.B++]=128+(h>>6&63)),this.U[this.B++]=128+(63&h))}return this.B-t}return t=this.q(i,this.B),this.B+=t,t}F(t){var i=t.length,s=new Uint8Array(i+6);return s[0]=131,s[1]=80,s[2]=i>>24,s[3]=i>>16&255,s[4]=i>>8&255,s[5]=255&i,s.set(t,6),s}async S(t){var i=[];let s=0;for(;;){var{done:h,value:e}=await t.read();if(e&&(i.push(e),s+=e.length),h)break}var r=new Uint8Array(s+6);r[0]=131,r[1]=80,r[2]=s>>24,r[3]=s>>16&255,r[4]=s>>8&255,r[5]=255&s;let n=6;for(let t=0;t<i.length;t++){var a=i[t];r.set(a,n),n+=a.length}return r}}});